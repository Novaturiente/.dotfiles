#+title: Config

* General Settings
*** Look & Feel
#+begin_src emacs-lisp
(require 'hideshow)
(setq doom-font (font-spec :family "JetBrains Mono NL Nerd Font" :size 15))
(when (display-graphic-p)
  (set-face-attribute 'default nil :weight 'semibold))

;; (add-to-list 'custom-theme-load-path "~/.doom.d/themes")
;; (load-theme 'doom-rose-pine t)
(setq doom-theme 'doom-challenger-deep)

(set-frame-parameter nil 'alpha-background 90)
(add-to-list 'default-frame-alist '(alpha-background . 90))
#+end_src

*** Settings
#+begin_src emacs-lisp
(setq display-line-numbers-type t)
(setq comint-terminal-type "xterm-256color")
(setq vterm-shell "/usr/bin/zsh")
(add-hook 'emacs-startup-hook #'vterm)
(add-hook 'after-init-hook #'spacious-padding-mode)

(add-hook 'after-make-frame-functions #'spacious-padding-mode)
(setq whole-line-or-region-mode 1)

(setq confirm-kill-emacs nil)
(setq confirm-kill-processes nil)
#+end_src


* Keybindings
*** Buffer and Window
#+begin_src emacs-lisp
(map! :leader
      :desc "Kill buffer" "q w" #'kill-current-buffer)
(map! :leader
      :desc "change window" "<left>" #'evil-window-left)
(map! :leader
      :desc "change window" "<right>" #'evil-window-right)

;; Unset existing bindings & Set M-<left> and M-<right> to switch buffers
(global-unset-key (kbd "M-<left>"))
(global-unset-key (kbd "M-<right>"))
(global-set-key (kbd "M-<left>") #'previous-buffer)
(global-set-key (kbd "M-<right>") #'next-buffer)

(defun close-window-and-kill-buffer ()
  "Kill the buffer associated with the current window and then close the window."
  (interactive)
  (kill-buffer)
  (delete-window))

(map! :leader
      :prefix "w"
      :desc "Close window and kill buffer"
      "w" #'close-window-and-kill-buffer)
#+end_src


*** Coding and Terminal
#+begin_src emacs-lisp
;; Open a vterm in a new vertical split window.
(defun my/vterm-open-vertical-split ()
  (interactive)
  (let ((buffer (generate-new-buffer "*vterm*")))
    (split-window-right)
    (other-window 1)
    (switch-to-buffer buffer)
    (vterm-mode)))

(map! :leader
      (:prefix "t"
       :desc "Open vterm in vertical split" "t" #'my/vterm-open-vertical-split))

(setq vterm-kill-buffer-on-exit t)
(setq kill-buffer-query-functions
      (remq 'process-kill-buffer-query-function kill-buffer-query-functions))

(map! :leader
      "=" #'+format/buffer)
#+end_src
*** General
#+begin_src emacs-lisp
;; Force TAB to insert two spaces in programming modes
(after! prog-mode
  (map! :map prog-mode-map
        :i [tab] (lambda () (interactive) (insert "  "))))
(global-set-key (kbd "TAB") (lambda () (interactive) (insert "  ")))

;; Tab Bar
(map! :leader
      :desc "Tab bar toggle" "t s" 'tab-bar-mode)
(map! :leader
      :desc "Tab new" "t n" 'tab-bar-new-tab)
(map! :leader
      :desc "Tab close" "t k" 'tab-bar-close-tab)
(map! :leader
      :desc "Tab next" "t <right>" 'tab-bar-switch-to-next-tab)
(map! :leader
      :desc "Tab prev" "t <left>" 'tab-bar-switch-to-prev-tab)

;; Treemacs
(map! :leader
      :desc "Open treemacs" "o o" 'treemacs)
#+end_src


* Language settings
*** Run python file
#+begin_src emacs-lisp
;; Commands
(defun my/uv-run-current-file ()
  "Run `uv run` on the current buffer's file."
  (interactive)
  (let ((file buffer-file-name))
    (unless file
      (user-error "Current buffer is not visiting a file"))
    (compile (format "uv run %s" (shell-quote-argument file)))))

(defun my/uv-run-current-file-with-arg (arg)
  "Prompt for ARG, then run `uv run` on the current file with ARG."
  (interactive (list (read-string "Argument(s) for uv run: ")))
  (let ((file buffer-file-name))
    (unless file
      (user-error "Current buffer is not visiting a file"))
    (compile (format "uv run %s %s"
                     (shell-quote-argument file)
                     arg))))
;; Keybindings only in python buffers
(after! python
  (map! :map python-mode-map
        :localleader
        (:prefix ("r" . "run")
         :desc "uv run current file" "r" #'my/uv-run-current-file
         :desc "uv run current file with arg" "a" #'my/uv-run-current-file-with-arg)))
#+end_src

*** Run rust
#+begin_src emacs-lisp
(defun my/cargo-project-root ()
  (when buffer-file-name
    (locate-dominating-file (file-name-directory buffer-file-name) "Cargo.toml")))

(defun my/rust--ensure-cargo-project ()
  (or (my/cargo-project-root)
      (user-error "Not in a Cargo project (no Cargo.toml found)")))

(defun my/rust-build-project ()
  (interactive)
  (let ((root (my/rust--ensure-cargo-project)))
    (let ((default-directory root))
      (compile "cargo build"))))

(defun my/rust-run-project ()
  (interactive)
  (let ((root (my/rust--ensure-cargo-project)))
    (let ((default-directory root))
      (compile "cargo run"))))

(defun my/rust-run-project-with-arg (arg)
  (interactive (list (read-string "Argument(s) for cargo run: ")))
  (let ((root (my/rust--ensure-cargo-project)))
    (let ((default-directory root))
      (compile (format "cargo run -- %s" arg)))))

;; Keybindings in Rust buffers only (support both rustic-mode and rust-mode)
(after! rustic
  (map! :map rustic-mode-map
        :localleader
        (:prefix ("r" . "run")
         :desc "cargo run project" "r" #'my/rust-run-project
         :desc "cargo run with args" "a" #'my/rust-run-project-with-arg
         :desc "cargo build"       "b" #'my/rust-build-project)))

(after! rust-mode
  (map! :map rust-mode-map
        :localleader
        (:prefix ("r" . "run")
         :desc "cargo run project" "r" #'my/rust-run-project
         :desc "cargo run with args" "a" #'my/rust-run-project-with-arg
         :desc "cargo build"       "b" #'my/rust-build-project)))
#+end_src

* Completion settings
#+begin_src emacs-lisp
;; Enable Corfu globally
(use-package! corfu
  :custom
  (corfu-auto t)                      ;; Enable auto completion
  (corfu-auto-delay 0.01)            ;; Shorter delay = faster feel
  (corfu-auto-prefix 1)              ;; Start completing after 1 character
  (corfu-cycle t)                    ;; Cycle around candidates
  (corfu-preselect-first t)          ;; Preselect first suggestion
  (corfu-quit-no-match 'separator)   ;; Auto-quit unless separator typed
  (corfu-popupinfo-mode t)           ;; Show documentation popups
  :init
  (global-corfu-mode)
  :config
    (define-key corfu-map (kbd "TAB") #'corfu-insert)
    (define-key corfu-map (kbd "<tab>") #'corfu-insert))

(use-package! corfu-popupinfo
  :after corfu
  :hook (corfu-mode . corfu-popupinfo-mode)
  :custom
  (corfu-popupinfo-delay 0.1)
  (corfu-popupinfo-max-width 80))

;; Use cape to enhance completion-at-point
(use-package! cape
  :defer nil
  :init
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)  ;; buffer words
  (add-to-list 'completion-at-point-functions #'cape-file)     ;; file paths
  (add-to-list 'completion-at-point-functions #'cape-keyword)  ;; keywords
  ;; (add-to-list 'completion-at-point-functions #'cape-symbol)   ;; elisp symbols
  ;; (add-to-list 'completion-at-point-functions #'cape-yasnippet)
)
(setq completion-ignore-case t)     ;; case-insensitive completions
(setq read-file-name-completion-ignore-case t)

(after! eglot
  (setq eglot-send-changes-idle-time 0.1) ; default is 0.5
  (setq eglot-sync-connect nil))          ; non-blocking startup

(add-hook 'python-mode-hook #'eglot-ensure)

;; Orderless: flexible matching
(use-package! orderless
  :init
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles basic partial-completion)))))

(setq corfu-quit-no-match 'separator)
(setq corfu-allow-prefix-predicate #'always)

(setq eldoc-idle-delay 0.1)
(defun my/disable-eldoc-in-minibuffer (orig-fun &rest args)
  (let ((inhibit-message t)) ;; suppress message echo
    (apply orig-fun args)))
(advice-add 'eldoc--message :around #'my/disable-eldoc-in-minibuffer)

;; On-demand documentation popup
(use-package! eldoc-box
  :after eglot
  :commands (eldoc-box-help-at-point))
(map! :after eglot
      :map eglot-mode-map
      :n "K" #'eldoc-box-help-at-point
      :leader
      :desc "LSP hover doc (popup)"
      "c h" #'eldoc-box-help-at-point)


;; Format on save
(add-hook 'before-save-hook
          (lambda ()
            (when (bound-and-true-p eglot-managed-mode)
              (eglot-format-buffer))))

#+end_src

* AI assistant
#+begin_src emacs-lisp
;; First, ensure PATH includes ~/.local/bin
(setenv "PATH"
        (concat (expand-file-name "~/.local/bin")
                ":" (getenv "PATH")))

;; Also adjust exec-path
(add-to-list 'exec-path (expand-file-name "~/.local/bin"))

(map! :leader
      :desc "Aider Menu" "z s" #'aider-run-aider)
(map! :leader
      :desc "Aider Transient Menu" "z a" #'aider-transient-menu)
#+end_src


* Org-mode settings
#+begin_src emacs-lisp

(setq org-directory "~/Notes/Org/")

(custom-theme-set-faces!
;; 'doom-one
'doom-rose-pine
'(org-level-1 :inherit outline-1 :height 1.5)
'(org-level-2 :inherit outline-2 :height 1.4)
'(org-level-3 :inherit outline-3 :height 1.3)
'(org-level-4 :inherit outline-2 :height 1.2)
'(org-level-5 :inherit outline-5 :height 1.1)
'(org-level-6 :inherit outline-6 :height 1.0)
'(org-level-7 :inherit outline-7 :height 1.0)
'(org-level-8 :inherit outline-8 :height 1.0))
;; '(org-document-title :height 1.6 :bold nil :underline nil))

(setq org-modern-table-vertical t)
(setq org-modern-table t)

(map! :leader
      :desc "Open todo.org"
      "o w" (lambda () (interactive) (find-file "~/Org/index.org")))
#+end_src

* Dashboard settings
#+begin_src emacs-lisp
;; ~/.doom.d/config.el

(defun my/doom-dashboard-ascii-banner ()
  (let ((banner '(
    "███▄▄▄▄    ▄██████▄   ▄█    █▄     ▄████████    ▄████████  ▄████████    ▄█    █▄   "
    "███▀▀▀██▄ ███    ███ ███    ███   ███    ███   ███    ███ ███    ███   ███    ███  "
    "███   ███ ███    ███ ███    ███   ███    ███   ███    ███ ███    █▀    ███    ███  "
    "███   ███ ███    ███ ███    ███   ███    ███  ▄███▄▄▄▄██▀ ███         ▄███▄▄▄▄███▄▄"
    "███   ███ ███    ███ ███    ███ ▀███████████ ▀▀███▀▀▀▀▀   ███        ▀▀███▀▀▀▀███▀ "
    "███   ███ ███    ███ ███    ███   ███    ███ ▀███████████ ███    █▄    ███    ███  "
    "███   ███ ███    ███ ███    ███   ███    ███   ███    ███ ███    ███   ███    ███  "
    " ▀█   █▀   ▀██████▀   ▀██████▀    ███    █▀    ███    ███ ████████▀    ███    █▀   "
    "                                               ███    ███                          "
)))
    (dolist (line banner)
      (insert (propertize line 'face 'doom-dashboard-banner) "\n"))))

;; ensure Doom uses it (works whether you start GUI or terminal;
;; the ASCII will only be visible in terminal frames)
(remove-hook '+doom-dashboard-functions #'doom-dashboard-widget-banner)
(remove-hook '+doom-dashboard-functions #'doom-dashboard-widget-shortmenu) ; removes menu
(remove-hook '+doom-dashboard-functions #'doom-dashboard-widget-footer)    ; removes footer
(add-hook '+doom-dashboard-functions #'my/doom-dashboard-ascii-banner)
#+end_src
